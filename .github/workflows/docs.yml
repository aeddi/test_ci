---
name: Docs
on:
  pull_request:
      branches:
        - master

jobs:
  gen_docs:
    name: Generate docs and changelog
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout changes
        uses: actions/checkout@v2

      - name: Set MERGE_SHA in env
        run: |
          git log --pretty=format:'%p' -1
          export SHA=$(git log --pretty=format:'%p' -1 | tr -d '[:space:]')
          echo "##[set-env name=MERGE_SHA;]$SHA"
          echo "$SHA"

      - name: Retrieve changelog from Github PR body
        run:
          sudo apt-get install jq;
          cat ${{ github.event_path }} | jq -r .pull_request.body > /tmp/body;
          cat /tmp/body | sed -ne '/^## Changelog/,$ p' > /tmp/changelog;

          if [[ -z $(cat /tmp/changelog) ]]; then
              echo "[Error] empty changelog"; exit 1;
          fi

          cat /tmp/changelog | sed '/<!--/,/-->/d' > /tmp/changelog_nc;

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v1
        with:
          name: changelog-v${{ env.MERGE_SHA }}
          path: /tmp/changelog_nc

